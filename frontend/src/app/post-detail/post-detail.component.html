<div class="post-detail-container">
  <!-- Breadcrumb -->
  <div class="post-breadcrumb">

    <a routerLink="/" class="breadcrumb-link">Inicio</a> <!-- Asegúrate de que la ruta sea correcta -->
    <span class="breadcrumb-separator">›</span>

    <a routerLink="/category" class="breadcrumb-link">Categorias</a> <!-- Asegúrate de que la ruta sea correcta -->
    <span class="breadcrumb-separator">›</span>
    <span>{{ post?.titulo }}</span>
  </div>

  <!-- Post Principal -->
  <div class="post-detail-card" *ngIf="post">
    <div class="post-detail-header">
      <h1 class="post-detail-title">{{ post.titulo }}</h1>

      <div class="post-detail-meta">
        <div class="post-detail-author">
          <div class="author-avatar-large">
            {{ getInitials(post.nombre_completo) }}
          </div>
          <div>
            <div style="color: #ffffff; font-weight: 600;">
              {{ post.nombre_completo }}
            </div>
            <div style="color: #a0aec0; font-size: 0.9rem;">Usuario</div>
          </div>
        </div>

        <div class="post-detail-time">
          <span>🕒</span>
          <span>{{ formatFechaRelativa(post.fecha_creacion) }}</span>
        </div>
      </div>

      <div class="post-detail-tags">
        <span class="post-detail-tag">{{ post.nombre_categoria }}</span>
      </div>
    </div>

    <div class="post-detail-content">
      <p>{{ post.contenido }}</p>
    </div>

    <div class="post-detail-stats">
      <div class="post-detail-stats-left">
        <div class="post-detail-stat">
          <div class="post-detail-stat">
            <span class="post-detail-stat-icon"><i class="bi bi-hand-thumbs-up"><svg xmlns="http://www.w3.org/2000/svg"
                  width="26" height="26" fill="currentColor" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
                  <path
                    d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z" />
                </svg></i></span>
            <span>{{ likes?.total_likes || 0 }} Me gusta</span>
            <button like-animation-container class="post-action-btn" (click)="toggleLike()" style="margin-left: 10px;">
              {{ likes?.user_liked ? '💔 Quitar like' : '👍 Dar like' }}
            </button>
          </div>

        </div>
        <div class="post-detail-stat">
          <span class="post-detail-stat-icon">💬</span>
          <span>{{ comments.length }} Comentarios</span>
        </div>
        <div class="post-detail-stat">
          <span class="post-detail-stat-icon">👁️</span>
          <span>{{ post.cantidad_vistas }} Vistas</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de Comentarios -->
  <div class="comments-section" *ngIf="comments.length > 0">
    <div class="comments-header">
      <h2 class="comments-title">
        <span>💬</span>
        Comentarios
        <span class="comments-count">({{ comments.length }})</span>
      </h2>
    </div>

    <!-- Template recursivo para comentarios anidados con límite de profundidad -->
    <ng-template #renderComments let-comments let-level="level">
      <div *ngFor="let comment of comments" class="comment-card" style="margin-bottom: 1.5rem;">
        <div class="comment-header">
          <div class="comment-author-info">
            <div class="comment-avatar">{{ getInitials(comment.nombre_completo) }}</div>
            <div class="comment-author-details">
              <div class="comment-author-name">{{ comment.nombre_completo }}</div>
              <div class="comment-author-role">Usuario</div>
            </div>
          </div>
          <div class="comment-time">
            <span>🕒</span>
            <span>{{ formatFechaRelativa(comment.fecha_comentario) }}</span>
          </div>
        </div>

        <div class="comment-content">
          {{ comment.contenido }}
        </div>

        <div class="comment-actions">
          <button class="comment-reply-btn"
            (click)="replyToComment(comment.id_comentario, comment.nombre_completo)">Responder</button>

          <!-- Botón eliminar solo visible para autor o admin -->
          <button *ngIf="userId === comment.id_usuario || userRole === 'admin'" class="comment-reply-btn"
            (click)="eliminarComentario(comment.id_comentario)">
            Eliminar
          </button>
        </div>

        <!-- Mostrar respuestas anidadas si estamos antes del nivel 3 -->
        <ng-container *ngIf="comment.respuestas?.length && level < 3">
          <div class="nested-comment">
            <ng-container
              *ngTemplateOutlet="renderComments; context: { $implicit: comment.respuestas, level: level + 1 }"></ng-container>
          </div>
        </ng-container>

        <!-- En nivel 3 mostrar las respuestas adicionales en forma plana debajo -->
        <ng-container *ngIf="comment.respuestas?.length && level === 3">
          <div class="comments-list" style="margin-top: 1rem;">
            <div *ngFor="let extraComment of comment.respuestas" class="comment-card" style="margin-bottom: 1.5rem;">
              <div class="comment-header">
                <div class="comment-author-info">
                  <div class="comment-avatar">{{ getInitials(extraComment.nombre_completo) }}</div>
                  <div class="comment-author-details">
                    <div class="comment-author-name">{{ extraComment.nombre_completo }}</div>
                    <div class="comment-author-role">Usuario</div>
                  </div>
                </div>
                <div class="comment-time">
                  <span>🕒</span>
                  <span>{{ formatFechaRelativa(extraComment.fecha_comentario) }}</span>
                </div>
              </div>
              <div class="comment-content">
                {{ extraComment.contenido }}
              </div>
              <div class="comment-actions">
                <button class="comment-reply-btn"
                  (click)="replyToComment(comment.id_comentario, comment.nombre_completo)">Responder</button>

                <!-- Botón eliminar solo visible para autor o admin -->

                <button class="comment-delete-btn" *ngIf="userId === extraComment.id_usuario || userRole === 'admin'"
                  class="comment-reply-btn" (click)="eliminarComentario(extraComment.id_comentario)"
                  style="background-color: #ff4d4d; border-color: #ff4d4d; margin-left: 10px;">
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        </ng-container>

      </div>
    </ng-template>

    <div class="comments-list">
      <ng-container *ngTemplateOutlet="renderComments; context: { $implicit: comments, level: 1 }"></ng-container>
    </div>
  </div>

  <!-- Formulario para agregar comentario -->
  <div class="add-comment-form">
    <h3 class="add-comment-title">{{ replyingTo ? 'Responder comentario' : 'Agregar comentario' }}</h3>

    <div *ngIf="replyingTo" class="replying-to-info" style="margin-bottom: 10px; color: #64b3f4;">
      Respondiendo a: <strong>{{ parentCommentAuthor }}</strong>
      <button (click)="cancelReply()"
        style="margin-left: 10px; background: transparent; border: none; color: #ff6b6b; cursor: pointer;">[Cancelar]</button>
    </div>

    <textarea class="comment-textarea" [(ngModel)]="newComment" placeholder="Escribe tu comentario aquí..."></textarea>
    <div class="comment-form-actions">
      <button class="comment-cancel-btn" (click)="cancelReply()" *ngIf="replyingTo">Cancelar</button>
      <button class="comment-submit-btn" (click)="submitComment()" [disabled]="!newComment.trim()">Publicar
        comentario</button>
    </div>
  </div>
</div>

